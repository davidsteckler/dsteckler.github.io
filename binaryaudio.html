<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8 Bit Note Stepper with Binary Music Maker</title>
  <style>
    :root {
      --bg: #0b0f1a;
      --text: #e8eefc;
      --muted: #a9b6d6;
      --accent: #7cf7c1;
      --accent2: #7cc7ff;
      --danger: #ff6b6b;

      --cardA: rgba(255,255,255,0.06);
      --cardB: rgba(255,255,255,0.02);
      --border: rgba(255,255,255,0.12);
      --panel: rgba(0,0,0,0.22);
      --panelBorder: rgba(255,255,255,0.10);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 700px at 30% 20%, #162347, var(--bg));
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }

    .wrap {
      width: min(1400px, 100%);
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 18px;
      align-items: start;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
    }

    .full { grid-column: 1 / -1; }

    h1 {
      font-size: 22px;
      margin: 0 0 10px 0;
      letter-spacing: 0.2px;
    }

    p {
      margin: 0 0 12px 0;
      color: var(--muted);
      line-height: 1.45;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    button {
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: 0.2px;
      transition: transform 0.05s ease, background 0.2s ease, border 0.2s ease, opacity 0.2s ease;
      user-select: none;
      touch-action: manipulation;
    }

    button:hover {
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.22);
    }

    button:active { transform: translateY(1px); }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .primary {
      border-color: rgba(124, 247, 193, 0.35);
      background: rgba(124, 247, 193, 0.10);
    }
    .primary:hover { background: rgba(124, 247, 193, 0.16); }

    .secondary {
      border-color: rgba(124, 199, 255, 0.35);
      background: rgba(124, 199, 255, 0.10);
    }
    .secondary:hover { background: rgba(124, 199, 255, 0.16); }

    .danger {
      border-color: rgba(255, 107, 107, 0.35);
      background: rgba(255, 107, 107, 0.10);
    }
    .danger:hover { background: rgba(255, 107, 107, 0.16); }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    .stat {
      background: var(--panel);
      border: 1px solid var(--panelBorder);
      border-radius: 14px;
      padding: 12px;
    }

    .label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.9px;
      margin-bottom: 6px;
    }

    .value { font-size: 18px; font-weight: 750; }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 15px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .binaryBox {
      border: 1px dashed rgba(124, 199, 255, 0.35);
      background: rgba(124, 199, 255, 0.08);
      border-radius: 14px;
      padding: 12px;
    }

    .tape {
      margin-top: 12px;
      max-height: 330px;
      overflow: auto;
      padding-right: 6px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      margin-bottom: 10px;
    }

    .row strong { color: var(--accent); }

    .pill {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      background: rgba(255,255,255,0.06);
      white-space: nowrap;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.45;
    }

    .topRow {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.28);
      color: var(--text);
      font-weight: 650;
      letter-spacing: 0.2px;
      outline: none;
    }

    .status {
      border: 1px solid rgba(124, 199, 255, 0.35);
      background: rgba(124, 199, 255, 0.10);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--text);
      white-space: nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .binInput {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      align-items: center;
    }

    .binInput input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.3);
      color: var(--text);
      font-family: ui-monospace, monospace;
      font-size: 16px;
      outline: none;
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 14px 0;
    }

    .keypad button {
      padding: 16px;
      font-size: 18px;
      font-weight: 700;
    }

    .sequence {
      margin-top: 14px;
      max-height: 220px;
      overflow: auto;
      padding: 10px;
      background: rgba(0,0,0,0.25);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
    }

    .seqItem {
      display: inline-block;
      margin: 4px;
      padding: 8px 12px;
      background: rgba(124, 247, 193, 0.15);
      border: 1px solid rgba(124, 247, 193, 0.3);
      border-radius: 8px;
      font-family: ui-monospace, monospace;
      font-size: 13px;
    }

    .seqItem .note {
      color: var(--accent);
      font-weight: 700;
    }

    .seqItem .bin {
      color: var(--muted);
      font-size: 11px;
      margin-left: 6px;
    }

    .paletteHeader {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .paletteControls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .paletteGrid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(16, 1fr);
      gap: 8px;
    }

    .bitCell {
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 10px;
      cursor: pointer;
      transition: transform 0.05s ease, background 0.2s ease, border 0.2s ease;
      user-select: none;
      min-height: 58px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      touch-action: manipulation;
    }

    .bitCell:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.18);
    }

    .bitCell:active { transform: translateY(1px); }

    .bitTop {
      font-family: ui-monospace, monospace;
      font-size: 12px;
      color: var(--text);
      opacity: 0.95;
    }

    .bitBottom {
      font-family: ui-monospace, monospace;
      font-size: 11px;
      color: var(--muted);
    }

    .bitCell.active {
      border-color: rgba(124, 247, 193, 0.50);
      background: rgba(124, 247, 193, 0.10);
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      font-weight: 650;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }

    .toggle input { accent-color: #7cf7c1; }

    @media (max-width: 1200px) {
      .wrap { grid-template-columns: 1fr 1fr; }
      .paletteGrid { grid-template-columns: repeat(12, 1fr); }
    }

    @media (max-width: 860px) {
      .wrap { grid-template-columns: 1fr; }
      .paletteGrid { grid-template-columns: repeat(8, 1fr); }
      body { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Card 1 -->
    <div class="card">
      <div class="topRow">
        <div>
          <h1>8 bit note stepper</h1>
          <p>
            Tap for quick notes. Press and hold for long notes.
            Each note shows its 8 bit MIDI binary.
          </p>
        </div>
        <div class="status" id="statusBadge">status: ready</div>
      </div>

      <div class="label">Choose a prebuilt melody</div>
      <select id="songSelect" aria-label="Select a melody"></select>

      <div class="controls">
        <button id="nextBtn" class="primary" title="Press and hold to sustain the next note">Play next note (hold)</button>
        <button id="playAllBtn" class="secondary">Play full melody</button>
        <button id="pauseBtn">Pause</button>
        <button id="resetBtn">Reset</button>
        <button id="stopBtn" class="danger">Stop sound</button>
      </div>

      <div class="grid">
        <div class="stat">
          <div class="label">Index</div>
          <div class="value" id="idxVal">0</div>
        </div>
        <div class="stat">
          <div class="label">Total notes</div>
          <div class="value" id="totalVal">0</div>
        </div>

        <div class="stat">
          <div class="label">Note</div>
          <div class="value" id="noteVal">Ready</div>
        </div>
        <div class="stat">
          <div class="label">Frequency</div>
          <div class="value" id="freqVal">0 Hz</div>
        </div>

        <div class="stat">
          <div class="label">MIDI number</div>
          <div class="value" id="midiVal">0</div>
        </div>
        <div class="stat">
          <div class="label">Duration</div>
          <div class="value" id="durVal">0 ms</div>
        </div>
      </div>

      <div style="margin-top: 14px;" class="binaryBox">
        <div class="label">8 bit binary for this note (MIDI)</div>
        <div class="mono" id="binVal">00000000</div>
        <div class="small">
          MIDI fits 0 to 127, so the first bit is usually 0. Rests show 00000000.
          If audio does not start, click a play button once to unlock it.
        </div>
      </div>
    </div>

    <!-- Card 2 -->
    <div class="card">
      <h1>Played notes tape</h1>
      <p>Each row logs what just played, plus the 8 bit MIDI binary.</p>
      <div class="tape" id="tape"></div>
    </div>

    <!-- Card 3 -->
    <div class="card">
      <h1>Binary music maker</h1>
      <p>
        Press and hold Play to control duration.
        Add REST the same way, hold for how long you want the silence.
      </p>

      <div class="binInput">
        <input type="number" id="binInputField" min="0" max="255" placeholder="0 to 255" />
        <button id="playBinBtn" class="primary" title="Press and hold to set note length">Play (hold)</button>
        <button id="restBtn" class="secondary" title="Press and hold to set rest length">REST (hold)</button>
      </div>

      <div class="keypad">
        <button class="binKey" data-val="0">0</button>
        <button class="binKey" data-val="1">1</button>
        <button class="binKey" data-val="2">2</button>
        <button class="binKey" data-val="3">3</button>
        <button class="binKey" data-val="4">4</button>
        <button class="binKey" data-val="5">5</button>
        <button class="binKey" data-val="6">6</button>
        <button class="binKey" data-val="7">7</button>
        <button class="binKey" data-val="8">8</button>
        <button class="binKey" data-val="9">9</button>
        <button class="binKey" data-val="127">127</button>
        <button class="binKey" data-val="255">255</button>
      </div>

      <div class="controls">
        <button id="clearSeqBtn" class="danger">Clear sequence</button>
        <button id="playSeqBtn" class="secondary">Play sequence</button>
      </div>

      <div class="binaryBox" style="margin-top: 14px;">
        <div class="label">Your sequence</div>
        <div class="sequence" id="sequence">
          <div class="small" style="color: var(--muted);">Play notes to build your sequence...</div>
        </div>
      </div>

      <div class="small" style="margin-top: 10px;">
        Tip: hold longer for that classic chiptune sustain, or tap for quick blips.
      </div>
    </div>

    <!-- Full width palette -->
    <div class="card full">
      <div class="paletteHeader">
        <div>
          <h1>0 to 255 binary palette</h1>
          <p>
            Press and hold a tile to control note duration.
            Each tile shows decimal and its 8 bit binary.
          </p>
        </div>

        <div class="paletteControls">
          <label class="toggle" title="When on, holding a tile plays audio. When off, holding a tile only adds to the sequence with a default duration.">
            <input type="checkbox" id="paletteSoundToggle" checked />
            <span>Sound on click</span>
          </label>
          <button id="paletteClearActiveBtn">Clear highlight</button>
        </div>
      </div>

      <div class="binaryBox">
        <div class="label">Tip</div>
        <div class="small" style="margin-top: 0;">
          The highlight marks the last value you clicked. Use this like a keyboard for building patterns.
        </div>
      </div>

      <div class="paletteGrid" id="paletteGrid" aria-label="Binary palette grid"></div>
    </div>
  </div>

  <script>
    // ============================================================
    // Pitch policy (retro friendly)
    // ============================================================
    const MELODY_TRANSPOSE_OCTAVES = -2;
    const MELODY_TRANSPOSE_SEMITONES = MELODY_TRANSPOSE_OCTAVES * 12;

    function clampMidi(m) {
      return Math.max(0, Math.min(127, m | 0));
    }

    function transposeMidi(midi, semitoneShift) {
      return clampMidi(midi + (semitoneShift | 0));
    }

    // ============================================================
    // Prebuilt melodies
    // ============================================================
    const SONGS = [
      {
        name: "Epic Melody",
        notes: [
          { note: "E5", durMs: 120, vel: 0.22 },
          { note: "E5", durMs: 120, vel: 0.20 },
          { note: "E5", durMs: 120, vel: 0.22 },
          { note: "REST", durMs: 120, vel: 0.00 },
          { note: "E5", durMs: 120, vel: 0.22 },
          { note: "REST", durMs: 120, vel: 0.00 },
          { note: "C5", durMs: 120, vel: 0.20 },
          { note: "E5", durMs: 240, vel: 0.24 },

          { note: "G5", durMs: 240, vel: 0.26 },
          { note: "REST", durMs: 240, vel: 0.00 },
          { note: "G4", durMs: 240, vel: 0.20 },
          { note: "REST", durMs: 240, vel: 0.00 },

          { note: "C5", durMs: 180, vel: 0.22 },
          { note: "REST", durMs: 120, vel: 0.00 },
          { note: "G4", durMs: 180, vel: 0.18 },
          { note: "REST", durMs: 120, vel: 0.00 },
          { note: "E4", durMs: 180, vel: 0.18 },
          { note: "REST", durMs: 120, vel: 0.00 },
          { note: "A4", durMs: 160, vel: 0.20 },
          { note: "B4", durMs: 160, vel: 0.20 },
          { note: "Bb4", durMs: 140, vel: 0.18 },
          { note: "A4", durMs: 240, vel: 0.22 },

          { note: "G4", durMs: 140, vel: 0.18 },
          { note: "E5", durMs: 140, vel: 0.20 },
          { note: "G5", durMs: 140, vel: 0.20 },
          { note: "A5", durMs: 180, vel: 0.22 },
          { note: "F5", durMs: 140, vel: 0.20 },
          { note: "G5", durMs: 140, vel: 0.20 },
          { note: "REST", durMs: 120, vel: 0.00 },
          { note: "E5", durMs: 180, vel: 0.20 },
          { note: "C5", durMs: 140, vel: 0.18 },
          { note: "D5", durMs: 140, vel: 0.18 },
          { note: "B4", durMs: 240, vel: 0.22 },

          { note: "G5", durMs: 120, vel: 0.24 },
          { note: "F#5", durMs: 120, vel: 0.22 },
          { note: "F5", durMs: 120, vel: 0.22 },
          { note: "D#5", durMs: 180, vel: 0.24 },
          { note: "E5", durMs: 140, vel: 0.22 },
          { note: "REST", durMs: 120, vel: 0.00 },

          { note: "C5", durMs: 360, vel: 0.26 },
          { note: "REST", durMs: 240, vel: 0.00 },
        ]
      },
      {
        name: "Overworld Walk",
        notes: [
          { note: "E5", durMs: 160, vel: 0.18 },
          { note: "G5", durMs: 160, vel: 0.18 },
          { note: "A5", durMs: 220, vel: 0.20 },
          { note: "B5", durMs: 220, vel: 0.20 },
          { note: "A5", durMs: 160, vel: 0.18 },
          { note: "G5", durMs: 160, vel: 0.18 },
          { note: "E5", durMs: 220, vel: 0.20 },
          { note: "REST", durMs: 140, vel: 0.00 },

          { note: "D5", durMs: 160, vel: 0.18 },
          { note: "F#5", durMs: 160, vel: 0.18 },
          { note: "G5", durMs: 220, vel: 0.20 },
          { note: "A5", durMs: 220, vel: 0.20 },
          { note: "G5", durMs: 160, vel: 0.18 },
          { note: "F#5", durMs: 160, vel: 0.18 },
          { note: "D5", durMs: 220, vel: 0.20 },
          { note: "REST", durMs: 140, vel: 0.00 },

          { note: "C5", durMs: 160, vel: 0.18 },
          { note: "E5", durMs: 160, vel: 0.18 },
          { note: "F#5", durMs: 220, vel: 0.20 },
          { note: "G5", durMs: 220, vel: 0.20 },
          { note: "F#5", durMs: 160, vel: 0.18 },
          { note: "E5", durMs: 160, vel: 0.18 },
          { note: "C5", durMs: 260, vel: 0.20 },
          { note: "REST", durMs: 160, vel: 0.00 },

          { note: "D5", durMs: 160, vel: 0.18 },
          { note: "E5", durMs: 160, vel: 0.18 },
          { note: "G5", durMs: 220, vel: 0.20 },
          { note: "E5", durMs: 220, vel: 0.20 },
          { note: "D5", durMs: 220, vel: 0.20 },
          { note: "B4", durMs: 320, vel: 0.22 },
        ]
      },
      {
        name: "Dungeon Pulse",
        notes: [
          { note: "A4", durMs: 160, vel: 0.20 },
          { note: "REST", durMs: 60, vel: 0.00 },
          { note: "A4", durMs: 160, vel: 0.20 },
          { note: "REST", durMs: 60, vel: 0.00 },
          { note: "C5", durMs: 180, vel: 0.20 },
          { note: "A4", durMs: 180, vel: 0.20 },
          { note: "G4", durMs: 220, vel: 0.20 },
          { note: "REST", durMs: 100, vel: 0.00 },

          { note: "F4", durMs: 160, vel: 0.20 },
          { note: "REST", durMs: 60, vel: 0.00 },
          { note: "F4", durMs: 160, vel: 0.20 },
          { note: "REST", durMs: 60, vel: 0.00 },
          { note: "A4", durMs: 180, vel: 0.20 },
          { note: "F4", durMs: 180, vel: 0.20 },
          { note: "E4", durMs: 240, vel: 0.20 },
          { note: "REST", durMs: 120, vel: 0.00 },

          { note: "D4", durMs: 160, vel: 0.20 },
          { note: "F4", durMs: 160, vel: 0.20 },
          { note: "G4", durMs: 160, vel: 0.20 },
          { note: "A4", durMs: 200, vel: 0.22 },
          { note: "G4", durMs: 160, vel: 0.20 },
          { note: "F4", durMs: 160, vel: 0.20 },
          { note: "D4", durMs: 280, vel: 0.22 },
        ]
      },
      {
        name: "Victory Jingle",
        notes: [
          { note: "C5", durMs: 140, vel: 0.22 },
          { note: "E5", durMs: 140, vel: 0.22 },
          { note: "G5", durMs: 180, vel: 0.24 },
          { note: "C6", durMs: 240, vel: 0.26 },
          { note: "REST", durMs: 90, vel: 0.00 },
          { note: "B5", durMs: 140, vel: 0.22 },
          { note: "G5", durMs: 140, vel: 0.22 },
          { note: "E5", durMs: 200, vel: 0.22 },
          { note: "C5", durMs: 260, vel: 0.22 }
        ]
      }
    ];

    // ============================================================
    // Audio
    // ============================================================
    let audioCtx = null;
    let masterGain = null;
    let activeNodes = [];

    function ensureAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.55;
        masterGain.connect(audioCtx.destination);
      }
      if (audioCtx.state === "suspended") audioCtx.resume();
    }

    function stopAll() {
      for (const n of activeNodes) {
        try { n.stop(); } catch (e) {}
        try { n.disconnect(); } catch (e) {}
      }
      activeNodes = [];
    }

    function startTone(freqHz, vel) {
      ensureAudio();

      const safeFreq = Math.max(40, Math.min(6000, freqHz || 0));
      const now = audioCtx.currentTime;

      const osc = audioCtx.createOscillator();
      osc.type = "square";
      osc.frequency.setValueAtTime(safeFreq, now);

      const gain = audioCtx.createGain();
      const peak = Math.min(0.35, Math.max(0.02, vel || 0.18));

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(peak, now + 0.01);

      osc.connect(gain);
      gain.connect(masterGain);

      osc.start(now);

      activeNodes.push(osc, gain);

      return { osc, gain, startTimeMs: performance.now() };
    }

    function stopTone(handle) {
      if (!handle) return 0;
      const heldMs = Math.max(30, Math.round(performance.now() - handle.startTimeMs));

      const now = audioCtx ? audioCtx.currentTime : 0;
      try {
        handle.gain.gain.cancelScheduledValues(now);
        handle.gain.gain.setValueAtTime(Math.max(0.0001, handle.gain.gain.value), now);
        handle.gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);
      } catch (e) {}

      try { handle.osc.stop(now + 0.04); } catch (e) {}
      try { handle.osc.disconnect(); } catch (e) {}
      try { handle.gain.disconnect(); } catch (e) {}

      activeNodes = activeNodes.filter(x => x !== handle.osc && x !== handle.gain);
      return heldMs;
    }

    // ============================================================
    // Notes to MIDI and frequency
    // ============================================================
    const NOTE_TO_SEMITONE = {
      "C": 0, "C#": 1, "DB": 1,
      "D": 2, "D#": 3, "EB": 3,
      "E": 4,
      "F": 5, "F#": 6, "GB": 6,
      "G": 7, "G#": 8, "AB": 8,
      "A": 9, "A#": 10, "BB": 10,
      "B": 11
    };

    function parseNoteName(noteStr) {
      const s = String(noteStr || "").trim();
      if (!s || s.toUpperCase() === "REST") return { isRest: true };

      const m = s.match(/^([A-Ga-g])([#bB]?)(-?\d+)$/);
      if (!m) return { isRest: true };

      const letter = m[1].toUpperCase();
      const accidentalRaw = m[2] || "";
      const accidental = accidentalRaw === "b" ? "B" : accidentalRaw.toUpperCase();
      const octave = parseInt(m[3], 10);

      const key = (letter + accidental).toUpperCase();
      const semitone = NOTE_TO_SEMITONE[key];
      if (semitone === undefined || Number.isNaN(octave)) return { isRest: true };

      return { isRest: false, octave, semitone, letter, accidentalRaw };
    }

    function midiFromParsed(p) {
      return (p.octave + 1) * 12 + p.semitone;
    }

    function freqFromMidi(midi) {
      return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function to8BitBinary(n) {
      const clamped = Math.max(0, Math.min(255, n | 0));
      return clamped.toString(2).padStart(8, "0");
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ============================================================
    // Stepper UI and playback
    // ============================================================
    const songSelect = document.getElementById("songSelect");
    const statusBadge = document.getElementById("statusBadge");

    const nextBtn = document.getElementById("nextBtn");
    const playAllBtn = document.getElementById("playAllBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const resetBtn = document.getElementById("resetBtn");
    const stopBtn = document.getElementById("stopBtn");

    const idxVal = document.getElementById("idxVal");
    const totalVal = document.getElementById("totalVal");
    const noteVal = document.getElementById("noteVal");
    const freqVal = document.getElementById("freqVal");
    const midiVal = document.getElementById("midiVal");
    const durVal = document.getElementById("durVal");
    const binVal = document.getElementById("binVal");
    const tape = document.getElementById("tape");

    let currentSongIndex = 0;
    let melody = SONGS[currentSongIndex].notes;

    let i = 0;
    let isPlayingAll = false;
    let playAllTimer = null;

    function setStatus(text) {
      statusBadge.textContent = `status: ${text}`;
    }

    function setButtons() {
      nextBtn.disabled = isPlayingAll;
      playAllBtn.disabled = isPlayingAll;
      pauseBtn.disabled = !isPlayingAll;
    }

    function logRow(noteText, midi, bin, freq, dur) {
      const div = document.createElement("div");
      div.className = "row";

      const left = document.createElement("div");
      left.innerHTML = `<strong>${escapeHtml(noteText)}</strong>
        <div class="small">midi ${midi} &nbsp;&nbsp; freq ${freq} hz &nbsp;&nbsp; dur ${dur} ms</div>`;

      const right = document.createElement("div");
      right.className = "pill";
      right.textContent = bin;

      div.appendChild(left);
      div.appendChild(right);
      tape.prepend(div);
    }

    function updateHeader(index, displayNote, midi, freq, dur, bin) {
      idxVal.textContent = String(index);
      noteVal.textContent = displayNote;
      freqVal.textContent = displayNote === "REST" ? "0 Hz" : `${Math.round(freq)} Hz`;
      midiVal.textContent = String(displayNote === "REST" ? 0 : midi);
      durVal.textContent = `${dur} ms`;
      binVal.textContent = bin;
    }

    function getPlayedNoteForIndex(index) {
      if (melody.length === 0) return null;
      if (index >= melody.length) index = 0;

      const item = melody[index];
      const parsed = parseNoteName(item.note);

      if (parsed.isRest) {
        return {
          type: "REST",
          item,
          displayNote: "REST",
          midi: 0,
          freq: 0,
          bin: "00000000",
          vel: 0.0
        };
      }

      const rawMidi = midiFromParsed(parsed);
      const playedMidi = transposeMidi(rawMidi, MELODY_TRANSPOSE_SEMITONES);
      const playedOctave = (parsed.octave + MELODY_TRANSPOSE_OCTAVES);

      const displayNote = `${parsed.letter}${parsed.accidentalRaw}${playedOctave}`;
      const freq = freqFromMidi(playedMidi);
      const bin = to8BitBinary(playedMidi);

      return {
        type: "NOTE",
        item,
        displayNote,
        midi: playedMidi,
        freq,
        bin,
        vel: item.vel || 0.18
      };
    }

    // Hold logic for stepper
    let stepHold = null;

    function beginStepHold() {
      ensureAudio();
      if (isPlayingAll) return;

      if (stepHold) return;

      setStatus("holding");

      const n = getPlayedNoteForIndex(i);
      if (!n) return;

      updateHeader(i + 1, n.displayNote, n.midi, n.freq, 0, n.bin);

      if (n.type === "NOTE") {
        const tone = startTone(n.freq, n.vel);
        stepHold = { kind: "NOTE", tone, meta: n, indexAtPress: i };
      } else {
        stepHold = { kind: "REST", meta: n, startTimeMs: performance.now(), indexAtPress: i };
      }
    }

    function endStepHold() {
      if (!stepHold) return;

      let heldMs = 0;

      if (stepHold.kind === "NOTE") {
        heldMs = stopTone(stepHold.tone);
      } else {
        heldMs = Math.max(30, Math.round(performance.now() - stepHold.startTimeMs));
      }

      const meta = stepHold.meta;

      updateHeader(stepHold.indexAtPress + 1, meta.displayNote, meta.midi, meta.freq, heldMs, meta.bin);
      logRow(meta.displayNote, meta.displayNote === "REST" ? 0 : meta.midi, meta.bin, meta.displayNote === "REST" ? 0 : Math.round(meta.freq), heldMs);

      i = stepHold.indexAtPress + 1;
      if (i >= melody.length) i = 0;

      stepHold = null;
      setStatus("ready");
    }

    // Prevent context menu on long press
    nextBtn.addEventListener("contextmenu", (e) => e.preventDefault());

    // Pointer events: works for mouse and touch
    nextBtn.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      beginStepHold();
      try { nextBtn.setPointerCapture(e.pointerId); } catch (err) {}
    });

    nextBtn.addEventListener("pointerup", (e) => {
      e.preventDefault();
      endStepHold();
    });

    nextBtn.addEventListener("pointercancel", () => endStepHold());
    nextBtn.addEventListener("pointerleave", () => {
      // Only end if mouse is down style hold, pointerleave can happen for mouse drag out
      // Safer to keep it simple: do nothing here.
    });

    function playAll() {
      ensureAudio();
      if (isPlayingAll) return;

      isPlayingAll = true;
      setButtons();
      setStatus("playing full melody");

      const loop = () => {
        if (!isPlayingAll) return;

        const n = getPlayedNoteForIndex(i);
        if (!n) return;

        const dur = Math.max(30, n.item.durMs || 150);

        if (n.type === "NOTE") {
          // Use scheduled short note for the prebuilt playback
          const tone = startTone(n.freq, n.vel);
          setTimeout(() => { stopTone(tone); }, dur);
        }

        updateHeader(i + 1, n.displayNote, n.midi, n.freq, dur, n.bin);
        logRow(n.displayNote, n.displayNote === "REST" ? 0 : n.midi, n.bin, n.displayNote === "REST" ? 0 : Math.round(n.freq), dur);

        i = i + 1;
        if (i >= melody.length) i = 0;

        playAllTimer = setTimeout(loop, dur);
      };

      loop();
    }

    function pauseAll() {
      if (!isPlayingAll) return;
      isPlayingAll = false;
      if (playAllTimer) clearTimeout(playAllTimer);
      playAllTimer = null;
      setButtons();
      setStatus("paused");
    }

    function resetStepper(alsoClearTape = true) {
      pauseAll();
      stopAll();
      stepHold = null;

      i = 0;

      idxVal.textContent = "0";
      noteVal.textContent = "Ready";
      freqVal.textContent = "0 Hz";
      midiVal.textContent = "0";
      durVal.textContent = "0 ms";
      binVal.textContent = "00000000";

      if (alsoClearTape) tape.innerHTML = "";

      totalVal.textContent = melody.length;
      setStatus("ready");
      setButtons();
    }

    function loadSongsIntoSelect() {
      songSelect.innerHTML = "";
      SONGS.forEach((s, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = s.name;
        songSelect.appendChild(opt);
      });
      songSelect.value = String(currentSongIndex);
    }

    songSelect.addEventListener("change", () => {
      currentSongIndex = parseInt(songSelect.value, 10) || 0;
      melody = SONGS[currentSongIndex].notes;
      resetStepper(true);
    });

    playAllBtn.addEventListener("click", playAll);
    pauseBtn.addEventListener("click", pauseAll);
    resetBtn.addEventListener("click", () => resetStepper(true));
    stopBtn.addEventListener("click", () => { stopAll(); stepHold = null; setStatus("ready"); });

    loadSongsIntoSelect();
    resetStepper(true);

    // ============================================================
    // Binary music maker logic (retro pitch range + hold durations)
    // ============================================================
    const binInputField = document.getElementById("binInputField");
    const playBinBtn = document.getElementById("playBinBtn");
    const restBtn = document.getElementById("restBtn");
    const clearSeqBtn = document.getElementById("clearSeqBtn");
    const playSeqBtn = document.getElementById("playSeqBtn");
    const sequence = document.getElementById("sequence");
    const binKeys = document.querySelectorAll(".binKey");

    let userSequence = [];

    const PENTATONIC_INTERVALS = [0, 2, 4, 7, 9];

    const MAKER_BASE_OCTAVE = 3;     // C3
    const MAKER_OCTAVES = 3;         // C3..A5
    const MAKER_STEPS_MAX = (MAKER_OCTAVES * 5) - 1; // 0..14

    function mapValueToMidi(val) {
      const v = Math.max(0, Math.min(255, val | 0));

      const step = Math.floor((v / 255) * MAKER_STEPS_MAX);
      const octaveOffset = Math.floor(step / 5);
      const noteInScale = step % 5;

      const semitone = PENTATONIC_INTERVALS[noteInScale];
      const octave = MAKER_BASE_OCTAVE + octaveOffset;
      const midi = (octave + 1) * 12 + semitone;

      return clampMidi(midi);
    }

    function noteNameFromMidi(midi) {
      const octave = Math.floor(midi / 12) - 1;
      const semitone = midi % 12;
      const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      return noteNames[semitone] + octave;
    }

    function updateSequenceDisplay() {
      if (userSequence.length === 0) {
        sequence.innerHTML = '<div class="small" style="color: var(--muted);">Play notes to build your sequence...</div>';
        return;
      }

      sequence.innerHTML = "";
      for (const item of userSequence) {
        const div = document.createElement("div");
        div.className = "seqItem";

        if (item.type === "REST") {
          div.innerHTML = `<span class="note">REST</span><span class="bin">dur ${item.durMs} ms</span>`;
        } else {
          div.innerHTML = `<span class="note">${escapeHtml(item.noteName)}</span><span class="bin">${item.bin} (${item.val}) dur ${item.durMs} ms</span>`;
        }

        sequence.appendChild(div);
      }
    }

    // Hold state for maker plays
    let makerHold = null;

    function commitMakerNote(noteObj, heldMs) {
      const durMs = Math.max(30, heldMs | 0);
      userSequence.push({ ...noteObj, durMs });
      updateSequenceDisplay();
    }

    function beginMakerHoldForValue(val) {
      ensureAudio();
      if (makerHold) return;

      const v = Math.max(0, Math.min(255, val | 0));
      const midi = mapValueToMidi(v);
      const freq = freqFromMidi(midi);
      const bin = to8BitBinary(v);
      const noteName = noteNameFromMidi(midi);

      const tone = startTone(freq, 0.20);

      makerHold = {
        kind: "NOTE",
        tone,
        noteObj: { type: "NOTE", val: v, midi, bin, noteName, freq }
      };
    }

    function beginMakerHoldRest() {
      ensureAudio();
      if (makerHold) return;

      makerHold = {
        kind: "REST",
        startTimeMs: performance.now(),
        noteObj: { type: "REST" }
      };
    }

    function endMakerHold() {
      if (!makerHold) return;

      let heldMs = 0;

      if (makerHold.kind === "NOTE") {
        heldMs = stopTone(makerHold.tone);
      } else {
        heldMs = Math.max(30, Math.round(performance.now() - makerHold.startTimeMs));
      }

      commitMakerNote(makerHold.noteObj, heldMs);
      makerHold = null;
    }

    // Play (hold) button
    playBinBtn.addEventListener("contextmenu", (e) => e.preventDefault());
    playBinBtn.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      const val = parseInt(binInputField.value, 10);
      if (Number.isNaN(val) || val < 0 || val > 255) {
        alert("Please enter a number between 0 and 255");
        return;
      }
      beginMakerHoldForValue(val);
      try { playBinBtn.setPointerCapture(e.pointerId); } catch (err) {}
    });
    playBinBtn.addEventListener("pointerup", (e) => { e.preventDefault(); endMakerHold(); });
    playBinBtn.addEventListener("pointercancel", () => endMakerHold());

    // REST (hold) button
    restBtn.addEventListener("contextmenu", (e) => e.preventDefault());
    restBtn.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      beginMakerHoldRest();
      try { restBtn.setPointerCapture(e.pointerId); } catch (err) {}
    });
    restBtn.addEventListener("pointerup", (e) => { e.preventDefault(); endMakerHold(); });
    restBtn.addEventListener("pointercancel", () => endMakerHold());

    // Keypad: tap sets value, still uses hold on Play
    binKeys.forEach(btn => {
      btn.addEventListener("click", () => {
        const val = parseInt(btn.dataset.val, 10);
        binInputField.value = String(val);
      });
    });

    function clearSequence() {
      userSequence = [];
      updateSequenceDisplay();
    }

    async function playSequence() {
      if (userSequence.length === 0) return;
      ensureAudio();

      // Stop any hold before playing back
      if (makerHold) { endMakerHold(); }

      for (const item of userSequence) {
        const dur = Math.max(30, item.durMs || 180);

        if (item.type === "REST") {
          await new Promise(r => setTimeout(r, dur));
          continue;
        }

        const tone = startTone(item.freq, 0.20);
        await new Promise(r => setTimeout(r, dur));
        stopTone(tone);
        await new Promise(r => setTimeout(r, 20));
      }
    }

    clearSeqBtn.addEventListener("click", clearSequence);
    playSeqBtn.addEventListener("click", playSequence);

    updateSequenceDisplay();

    // ============================================================
    // 0 to 255 palette grid (hold to control duration)
    // ============================================================
    const paletteGrid = document.getElementById("paletteGrid");
    const paletteSoundToggle = document.getElementById("paletteSoundToggle");
    const paletteClearActiveBtn = document.getElementById("paletteClearActiveBtn");

    let lastActiveCell = null;
    function setActiveCell(cell) {
      if (lastActiveCell) lastActiveCell.classList.remove("active");
      lastActiveCell = cell;
      if (lastActiveCell) lastActiveCell.classList.add("active");
    }

    let paletteHold = null;

    function beginPaletteHold(value, cell) {
      ensureAudio();
      if (paletteHold) return;

      setActiveCell(cell);
      binInputField.value = String(value);

      const soundOn = paletteSoundToggle.checked;

      if (!soundOn) {
        // No sound mode: add immediately with a default duration.
        const v = Math.max(0, Math.min(255, value | 0));
        const midi = mapValueToMidi(v);
        const freq = freqFromMidi(midi);
        const bin = to8BitBinary(v);
        const noteName = noteNameFromMidi(midi);
        userSequence.push({ type: "NOTE", val: v, midi, bin, noteName, freq, durMs: 180 });
        updateSequenceDisplay();
        return;
      }

      const v = Math.max(0, Math.min(255, value | 0));
      const midi = mapValueToMidi(v);
      const freq = freqFromMidi(midi);
      const bin = to8BitBinary(v);
      const noteName = noteNameFromMidi(midi);

      const tone = startTone(freq, 0.20);

      paletteHold = {
        tone,
        noteObj: { type: "NOTE", val: v, midi, bin, noteName, freq }
      };
    }

    function endPaletteHold() {
      if (!paletteHold) return;
      const heldMs = stopTone(paletteHold.tone);
      commitMakerNote(paletteHold.noteObj, heldMs);
      paletteHold = null;
    }

    function buildPalette() {
      const frag = document.createDocumentFragment();

      for (let v = 0; v <= 255; v++) {
        const cell = document.createElement("div");
        cell.className = "bitCell";
        cell.dataset.val = String(v);

        const top = document.createElement("div");
        top.className = "bitTop";
        top.textContent = String(v).padStart(3, "0");

        const bottom = document.createElement("div");
        bottom.className = "bitBottom";
        bottom.textContent = to8BitBinary(v);

        cell.appendChild(top);
        cell.appendChild(bottom);

        cell.addEventListener("contextmenu", (e) => e.preventDefault());

        cell.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          const value = parseInt(cell.dataset.val, 10);
          beginPaletteHold(value, cell);
          try { cell.setPointerCapture(e.pointerId); } catch (err) {}
        });

        cell.addEventListener("pointerup", (e) => {
          e.preventDefault();
          endPaletteHold();
        });

        cell.addEventListener("pointercancel", () => endPaletteHold());

        frag.appendChild(cell);
      }

      paletteGrid.innerHTML = "";
      paletteGrid.appendChild(frag);
    }

    paletteClearActiveBtn.addEventListener("click", () => setActiveCell(null));
    buildPalette();
  </script>
</body>
</html>
