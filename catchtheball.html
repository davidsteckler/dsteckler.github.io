import React, { useState, useEffect, useCallback } from 'react';
import { AlertDialog, AlertDialogAction, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";
import { Ghost, Zap, Star, Award } from 'lucide-react';

const GAME_DURATION = 60;
const INITIAL_BALL_SIZE = 50;
const INITIAL_BALL_SPEED = 1000;

const getRandomPosition = (max) => Math.floor(Math.random() * max);

const BallCatcher = () => {
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(GAME_DURATION);
  const [ballPosition, setBallPosition] = useState({ x: 0, y: 0 });
  const [ballSize, setBallSize] = useState(INITIAL_BALL_SIZE);
  const [ballSpeed, setBallSpeed] = useState(INITIAL_BALL_SPEED);
  const [gameStarted, setGameStarted] = useState(false);
  const [showDialog, setShowDialog] = useState(false);
  const [dialogContent, setDialogContent] = useState({});
  const [theme, setTheme] = useState('default');
  const [powerUp, setPowerUp] = useState(null);

  const moveBall = useCallback(() => {
    const gameArea = document.getElementById('gameArea');
    if (gameArea) {
      const maxX = gameArea.clientWidth - ballSize;
      const maxY = gameArea.clientHeight - ballSize;
      setBallPosition({
        x: getRandomPosition(maxX),
        y: getRandomPosition(maxY),
      });
    }
  }, [ballSize]);

  const handleCatch = () => {
    setScore((prevScore) => prevScore + 1);
    moveBall();
    
    // Easter egg: Every 10th catch
    if (score > 0 && (score + 1) % 10 === 0) {
      setDialogContent({
        title: "Achievement Unlocked!",
        description: "You've caught 10 balls! Here's a fun fact: The world record for most balls juggled is 11 balls for 23 catches!",
      });
      setShowDialog(true);
    }

    // Difficulty increase
    if (score > 0 && (score + 1) % 5 === 0) {
      setBallSize((prevSize) => Math.max(prevSize - 5, 20));
      setBallSpeed((prevSpeed) => Math.max(prevSpeed - 50, 500));
    }

    // Random power-up
    if (Math.random() < 0.1) {
      const powerUps = ['freeze', 'double', 'magnet'];
      setPowerUp(powerUps[Math.floor(Math.random() * powerUps.length)]);
    }
  };

  const startGame = () => {
    setGameStarted(true);
    setScore(0);
    setTimeLeft(GAME_DURATION);
    setBallSize(INITIAL_BALL_SIZE);
    setBallSpeed(INITIAL_BALL_SPEED);
    moveBall();
  };

  useEffect(() => {
    if (gameStarted && timeLeft > 0) {
      const timer = setInterval(() => {
        setTimeLeft((prevTime) => prevTime - 1);
      }, 1000);

      return () => clearInterval(timer);
    } else if (timeLeft === 0) {
      setGameStarted(false);
      setDialogContent({
        title: "Game Over!",
        description: `Your final score is ${score}. Can you beat it next time?`,
      });
      setShowDialog(true);
    }
  }, [gameStarted, timeLeft, score]);

  useEffect(() => {
    if (gameStarted) {
      const interval = setInterval(moveBall, ballSpeed);
      return () => clearInterval(interval);
    }
  }, [gameStarted, ballSpeed, moveBall]);

  useEffect(() => {
    const themes = ['spooky', 'electric', 'space', 'underwater'];
    const randomTheme = themes[Math.floor(Math.random() * themes.length)];
    setTheme(randomTheme);
  }, []);

  const applyPowerUp = () => {
    switch (powerUp) {
      case 'freeze':
        setTimeLeft((prevTime) => prevTime + 5);
        break;
      case 'double':
        setScore((prevScore) => prevScore + 1);
        break;
      case 'magnet':
        setBallSize((prevSize) => prevSize * 1.5);
        setTimeout(() => setBallSize(INITIAL_BALL_SIZE), 5000);
        break;
      default:
        break;
    }
    setPowerUp(null);
  };

  const getThemeStyles = () => {
    switch (theme) {
      case 'spooky':
        return { backgroundColor: '#2c3e50', color: '#ecf0f1' };
      case 'electric':
        return { backgroundColor: '#f39c12', color: '#34495e' };
      case 'space':
        return { backgroundColor: '#2c3e50', color: '#e74c3c' };
      case 'underwater':
        return { backgroundColor: '#3498db', color: '#ecf0f1' };
      default:
        return { backgroundColor: '#fff', color: '#000' };
    }
  };

  return (
    <div id="gameArea" style={{ ...getThemeStyles(), position: 'relative', width: '600px', height: '400px', border: '2px solid #000', overflow: 'hidden' }}>
      <div style={{ position: 'absolute', top: '10px', left: '10px', fontSize: '18px' }}>Score: {score}</div>
      <div style={{ position: 'absolute', top: '10px', right: '10px', fontSize: '18px' }}>Time: {timeLeft}</div>
      {!gameStarted && (
        <button onClick={startGame} style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', padding: '10px 20px', fontSize: '18px' }}>
          Start Game
        </button>
      )}
      {gameStarted && (
        <div
          onClick={handleCatch}
          style={{
            position: 'absolute',
            left: `${ballPosition.x}px`,
            top: `${ballPosition.y}px`,
            width: `${ballSize}px`,
            height: `${ballSize}px`,
            borderRadius: '50%',
            backgroundColor: theme === 'spooky' ? '#7f8c8d' : 'red',
            cursor: 'pointer',
            transition: 'all 0.1s ease-out',
          }}
        />
      )}
      {powerUp && (
        <div onClick={applyPowerUp} style={{ position: 'absolute', top: '40px', left: '10px', cursor: 'pointer' }}>
          {powerUp === 'freeze' && <Zap size={24} color="#3498db" />}
          {powerUp === 'double' && <Star size={24} color="#f1c40f" />}
          {powerUp === 'magnet' && <Ghost size={24} color="#9b59b6" />}
        </div>
      )}
      {theme === 'underwater' && (
        <div style={{ position: 'absolute', bottom: '10px', left: '10px', fontSize: '24px' }}>🐠🐟🐡</div>
      )}
      {theme === 'space' && (
        <div style={{ position: 'absolute', top: '10px', left: '50%', transform: 'translateX(-50%)', fontSize: '24px' }}>🚀🌟🪐</div>
      )}
      <AlertDialog open={showDialog} onOpenChange={setShowDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>{dialogContent.title}</AlertDialogTitle>
            <AlertDialogDescription>{dialogContent.description}</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogAction onClick={() => setShowDialog(false)}>OK</AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default BallCatcher;
